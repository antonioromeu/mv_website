---
import '../styles/global.css'
import '@fontsource-variable/source-code-pro';
import { layoutContent } from '../content/layout';
import { getNavItems } from '../content/navigation';

interface Props {
    title: string;
    lang: 'en' | 'pt';
}

const { title, lang } = Astro.props;
const t = layoutContent[lang];
const navItems = getNavItems(lang);
const toggleLang = lang === 'pt' ? 'en' : 'pt';
const togglePath = `/${toggleLang}/`;
---

<html lang={lang} class="antialiased [text-size-adjust:100%]">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
        <link rel="apple-touch-icon" sizes="180x180" href="/favicon_io/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon_io/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon_io/favicon-16x16.png">
        <link rel="manifest" href="/favicon_io/site.webmanifest">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
        <title>{title}</title>
    </head>

    <body class="overscroll-y-none">
        <nav class="sticky top-0 z-50 w-full bg-(--color-off-white)">
            <div 
                style="height: var(--nav-height);"
                class="
                    w-full px-[3.5vw] pt-[2vh] flex flex-col items-start justify-center gap-6
                    md:flex-row md:justify-between md:pt-[4vh] md:gap-0"
            >
                <div class="flex w-full items-start justify-between md:w-auto md:justify-start md:gap-4">
                    <a 
                        href={`/${lang}/`} 
                        onclick="handleLogoClick(event)"
                        class="nav-link group block no-underline text-4xl font-black tracking-tighter leading-[0.5] text-current md:text-6xl"
                    >
                        MÃ¡rio Veloso<br>
                        <span class="text-sm font-normal tracking-[0.0em] md:text-xl">
                            {t.filmmaker}
                        </span>
                    </a>

                    <div class="text-[10px] font-bold tracking-widest pt-[0.6vh] md:pt-[2.5vh] md:text-xs">
                        <a href={togglePath} class="hover:opacity-50 transition-opacity uppercase">
                            ({toggleLang})
                        </a>
                    </div>
                </div>

                <div class="hidden md:flex text-lg font-bold text-current gap-[13vw] tracking-widest">
                    {navItems.map((item, index) => (
                        <div class="relative group cursor-pointer">
                            <span class="nav-link hover:opacity-50 pb-2 block transition-opacity pt-[5vh]">{item.title}</span>
                            <div class={
                                `absolute pt-4 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 min-w-64 z-50 
                                ${index === navItems.length - 1 ? 'right-0' : 'left-0'}`
                            }>
                                <div class="flex flex-col gap-4 bg-(--color-off-white) border border-current border-opacity-10 p-6 shadow-xl backdrop-blur-md">
                                    {item.links.map(link => (
                                        link.href ? 
                                        <a href={link.href} class="text-xs tracking-[0.2em] hover:opacity-50 transition-opacity whitespace-nowrap">{link.label}</a> : 
                                        <span class="text-xs tracking-[0.2em] opacity-50 whitespace-nowrap">{link.label}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div class="flex w-full md:hidden text-sm font-bold text-current justify-between tracking-widest">
                    {navItems.map((item, index) => ( // Added index here
                        <div class="relative mobile-dropdown-container">
                            <span class="nav-link cursor-pointer transition-opacity active:opacity-50">{item.title}</span>
                            <div class={
                                `mobile-dropdown-content pointer-events-none absolute top-full pt-4 opacity-0 scale-95 transition-all duration-300 min-w-40 z-60 
                                ${index === navItems.length - 1 ? 'right-0' : 'left-0'}`
                            }>
                                <div class="flex flex-col gap-4 bg-(--color-off-white) border border-current border-opacity-20 p-5 shadow-xl text-current backdrop-blur-md">
                                    {item.links.map(link => (
                                        link.href ? 
                                        <a href={link.href} class="text-[10px] tracking-[0.2em] whitespace-nowrap">{link.label}</a> : 
                                        <span class="text-[10px] tracking-[0.2em] opacity-50 whitespace-nowrap">{link.label}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </nav>
        
        <main>
            <slot />
        </main>
        
        <script>
            declare global {
                interface Window {
                    handleLogoClick: (e: MouseEvent) => void;
                }
            }

            // Global Logo Click handler
            window.handleLogoClick = function(event: MouseEvent) {
                if (event) event.preventDefault();
                document.body.scrollTo({ top: 0, behavior: 'smooth' });
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.pushState({}, document.title, cleanUrl);
            };

            document.addEventListener('DOMContentLoaded', () => {
                const body = document.body;
                const sections = document.querySelectorAll('.snap-section');
                const navLinks = document.querySelectorAll('.nav-link');
                const dropdowns = document.querySelectorAll('.mobile-dropdown-container');

                // SINGLE OPTIMIZED OBSERVER
                const observerOptions = {
                    rootMargin: '-45% 0px -45% 0px',
                    threshold: [0, 0.1, 0.2]
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const el = entry.target as HTMLElement;
                            const newColor = el.getAttribute('data-color') ?? '#0000fe';
                            const sectionId = el.getAttribute('id');

                            // 1. Update Body Color
                            requestAnimationFrame(() => {
                                body.style.color = newColor;
                            });

                            // 2. Update Nav Links
                            navLinks.forEach(link => {
                                const href = link.getAttribute('href');
                                const isActive = href && (href === `#${sectionId}` || href.endsWith(`/#${sectionId}`));
                                link.classList.toggle('nav-link-active', !!isActive);
                                (link as HTMLElement).style.color = isActive ? newColor : 'inherit';
                            });
                        }
                    });
                }, observerOptions);

                sections.forEach(section => observer.observe(section));

                // Mobile Dropdown Logic
                const closeAll = () => dropdowns.forEach(d => d.classList.remove('is-open'));

                dropdowns.forEach(container => {
                    container.querySelector('span')?.addEventListener('click', (e) => {
                        if (window.innerWidth < 768) {
                            e.stopPropagation();
                            const isOpen = container.classList.contains('is-open');
                            closeAll();
                            if (!isOpen) container.classList.add('is-open');
                        }
                    });
                });

                document.addEventListener('click', closeAll);
            });
        </script>
    </body>
</html>