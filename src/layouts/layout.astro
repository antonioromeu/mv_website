---
const { title, lang = 'en' } = Astro.props; // Default to EN
import '../styles/global.css'
import '@fontsource-variable/source-code-pro';
const base = import.meta.env.BASE_URL;

const translations = {
  pt: {
    films: "Filmes",
    photos: "Fotos",
    info: "Info",
    comingSoon: "Em breve",
    about: "Sobre Mim",
    festivals: "Festivais & Prémios",
    assistant: "Assistente de Realização",
    filmmaker: "Realizador, Portugal"
  },
  en: {
    films: "Films",
    photos: "Photos",
    info: "Info",
    comingSoon: "Coming Soon",
    about: "About Me",
    festivals: "Festivals & Awards",
    assistant: "Assistant Director",
    filmmaker: "Filmmaker, Portugal"
  }
};

const t = translations[lang as keyof typeof translations];

// 1. Data Structure to prevent HTML repetition
const navItems = [
  {
    title: t.films,
    links: [
      { label: "Chuvas de Verão", href: "#cdv-section" },
      { label: "Fora da Bouça", href: "#fdb-section" },
      { label: "Rio Torto", href: "#rt-section" },
    ]
  },
  {
    title: t.photos,
    links: [{ label: t.comingSoon, href: null }]
  },
  {
    title: t.info,
    links: [
      { label: t.about, href: "#about-section" },
      { label: t.festivals, href: "#festivals-awards-section" },
      { label: t.assistant, href: "#assistant-director-section" },
    ]
  }
];

// Determine the toggle link
const toggleLang = lang === 'pt' ? 'en' : 'pt';
const currentPath = Astro.url.pathname.replace(`${base}/${lang}`, '');
---

<html lang="{lang}" class="scroll-smooth antialiased [text-size-adjust:100%]">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
        <link rel="apple-touch-icon" sizes="180x180" href={`${base}/favicon_io/apple-touch-icon.png`}>
        <link rel="icon" type="image/png" sizes="32x32" href={`${base}/favicon_io/favicon-32x32.png`}>
        <link rel="icon" type="image/png" sizes="16x16" href={`${base}/favicon_io/favicon-16x16.png`}>
        <link rel="manifest" href={`${base}/favicon_io/site.webmanifest`}>
        <title>{title}</title>
    </head>

    <body class="overscroll-y-none">
        <nav class="sticky top-0 z-50 w-full bg-inherit">
            <div 
                style="height: var(--nav-height);"
                class="
                    w-full px-[3.5vw] pt-[2vh] flex flex-col items-start justify-center gap-6
                    md:flex-row md:justify-between md:pt-[4vh] md:gap-0"
            >
                <a 
                    href="javascript:void(0)" 
                    onclick="window.scrollTo({top: 0, behavior: 'smooth'}); history.pushState('', document.title, window.location.pathname);" 
                    class="
                        nav-link group block no_uderline text-4xl font-black tracking-tighter leading-[0.5] text-current
                        md:text-6xl"
                >
                    Mário Veloso<br>
                    <span class="
                        text-sm font-normal tracking-[0.0em]
                        md:text-xl"
                    >
                        Filmmaker, Portugal
                    </span>
                </a>

                <div class="hidden md:flex text-lg font-bold text-current gap-[13vw] tracking-widest">
                    {navItems.map((item, index) => (
                        <div class="relative group cursor-pointer">
                            <span class="nav-link hover:opacity-50 pb-2 block transition-opacity">{item.title}</span>
                            <div class={
                                `absolute pt-4 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 min-w-64 z-50 
                                ${index === navItems.length - 1 ? 'right-0' : 'left-0'}`
                            }>
                                <div class="flex flex-col gap-4 bg-(--color-off-white) border border-current border-opacity-10 p-6 shadow-xl backdrop-blur-md">
                                    {item.links.map(link => (
                                        link.href ? 
                                        <a href={link.href} class="text-xs tracking-[0.2em] hover:opacity-50 transition-opacity whitespace-nowrap">{link.label}</a> : 
                                        <span class="text-xs tracking-[0.2em] opacity-50 whitespace-nowrap">{link.label}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div class="flex w-full md:hidden text-sm font-bold text-current justify-between tracking-widest">
                    {navItems.map((item, index) => ( // Added index here
                        <div class="relative mobile-dropdown-container">
                            <span class="nav-link cursor-pointer transition-opacity active:opacity-50">{item.title}</span>
                            <div class={
                                `mobile-dropdown-content pointer-events-none absolute top-full pt-4 opacity-0 scale-95 transition-all duration-300 min-w-40 z-60 
                                ${index === navItems.length - 1 ? 'right-0' : 'left-0'}`
                            }>
                                <div class="flex flex-col gap-4 bg-(--color-off-white) border border-current border-opacity-20 p-5 shadow-xl text-current backdrop-blur-md">
                                    {item.links.map(link => (
                                        link.href ? 
                                        <a href={link.href} class="text-[10px] tracking-[0.2em] whitespace-nowrap">{link.label}</a> : 
                                        <span class="text-[10px] tracking-[0.2em] opacity-50 whitespace-nowrap">{link.label}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </nav>
        
        <main>
            <slot />
        </main>
        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const body = document.body;
                const dropdowns = document.querySelectorAll('.mobile-dropdown-container');

                // 1. Optimized Observer
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const newColor = (entry.target as HTMLElement).getAttribute('data-color') ?? '#0000fe';
                            requestAnimationFrame(() => body.style.color = newColor);
                        }
                    });
                }, { rootMargin: '-45% 0px -45% 0px', threshold: [0, 0.1] });

                document.querySelectorAll('.snap-section').forEach(s => observer.observe(s));

                // 2. Simplified Dropdown Logic
                const closeAll = () => dropdowns.forEach(d => d.classList.remove('is-open'));

                dropdowns.forEach(container => {
                    container.querySelector('span')?.addEventListener('click', (e) => {
                        if (window.innerWidth < 768) {
                            e.stopPropagation();
                            const isOpen = container.classList.contains('is-open');
                            closeAll();
                            if (!isOpen) container.classList.add('is-open');
                        }
                    });
                });

                document.addEventListener('click', closeAll);
                document.querySelectorAll('.mobile-dropdown-content a').forEach(a => a.addEventListener('click', closeAll));
            });
        </script>
    </body>
</html>