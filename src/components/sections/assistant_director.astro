---
import { adContent } from '../../content/assistant_director';

interface Props {
    lang: 'en' | 'pt';
}

const { lang = 'en' } = Astro.props;
const t = adContent[lang];

// Helper to chunk credits into pages of 4 for mobile
const perPage = 4;
const pages = Array.from({ length: Math.ceil(t.credits.length / perPage) }, (_, i) =>
    t.credits.slice(i * perPage, i * perPage + perPage)
);
const byLabel = lang === 'pt' ? 'de' : 'by';
---

<section 
    id="assistant-director" 
    data-color="var(--color-blue)" 
    class="snap-section shrink-0
           md:flex-row md:items-center"
    style="padding-top: var(--nav-height);"
>
    <!-- Mobile view -->
    <div class="flex flex-col w-full h-full overflow-hidden md:hidden">
        <!-- Header -->
        <div class="w-full px-[3.5vw] pt-[6vh] pb-[1vh]">
            <div class="border-b border-current pb-[1vh]">
                <span class="block text-xs font-bold">{t.title}</span>
            </div>
        </div>
        
        <!-- Scrollable pages container -->
        <div class="flex-1 overflow-x-auto snap-x snap-mandatory hide-scrollbar flex" id="assistant-scroll">
            {pages.map((page) => (
                <div class="w-full h-full snap-start flex px-[3.5vw] shrink-0">
                    <div class="text-[10px] leading-relaxed space-y-[1vh]">
                        {page.map(item => (
                            <div>
                                {item.link ? (
                                    <a href={item.link} target="_blank" class="mobile-double-tap no-underline font-bold">
                                        {item.title} {item.status}
                                    </a>
                                ) : (
                                    <strong>{item.title} {item.status}</strong>
                                )}
                                <br />{byLabel} {item.director}
                                <br />{item.type}
                                <br />{item.production}
                                <br />{item.role}
                                <br />{item.date}
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>

        <!-- Page indicators -->
        <div class="flex justify-center gap-2 py-[2vh]">
            {pages.map((_, i) => (
                <div class={`page-indicator-ad w-1.5 h-1.5 rounded-full bg-current transition-opacity ${i === 0 ? 'opacity-100' : 'opacity-30'}`} data-page={i}></div>
            ))}
        </div>
    </div>

    <!-- Desktop view -->
    <div class="hidden flex-col w-full h-full pt-[3vh] px-[3.5vw] md:flex">
        <div class="w-full border-b border-current pb-2 mb-3">
            <div class="flex flex-col">
                <span class="block font-bold text-lg">{t.title}</span>
            </div>
        </div>
        <div class="columns-4 gap-8 text-[10px] leading-relaxed">
            {t.credits.map(item => (
                <div class="break-inside-avoid mb-3">
                    {item.link ? (
                        <a href={item.link} target="_blank" class="hover:underline font-bold">
                            {item.title} {item.status}
                        </a>
                    ) : (
                        <strong>{item.title} {item.status}</strong>
                    )}
                    <br />{byLabel} {item.director}
                    <br />{item.type}
                    <br />{item.production}
                    <br />{item.role}
                    <br />{item.date}
                </div>
            ))}
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Page indicator logic for Assistant Director mobile view
        const scrollContainer = document.getElementById('assistant-scroll');
        const indicators = document.querySelectorAll('.page-indicator-ad');
        if (scrollContainer && indicators.length > 0) {
            scrollContainer.addEventListener('scroll', () => {
                const scrollLeft = scrollContainer.scrollLeft;
                const pageWidth = scrollContainer.clientWidth;
                const currentPage = Math.round(scrollLeft / pageWidth);

                indicators.forEach((indicator, index) => {
                    if (index === currentPage) {
                        (indicator as HTMLElement).style.opacity = '1';
                    } else {
                        (indicator as HTMLElement).style.opacity = '0.3';
                    }
                });
            });
        }

        // Handles the "First Tap = Style, Second Tap = Follow" mobile logic
        const links = document.querySelectorAll('.mobile-double-tap');
        links.forEach(link => {
            link.addEventListener('click', function(e) {
                // Only apply this logic on touch devices / mobile view
                if (window.innerWidth < 768) {
                    const htmlLink = e.currentTarget as HTMLElement;
                    
                    // If the link doesn't have the 'active-link' class yet
                    if (!htmlLink.classList.contains('active-link')) {
                        // Prevent the link from opening
                        e.preventDefault();
                        
                        // Remove 'active-link' from all other links first (optional)
                        links.forEach(l => l.classList.remove('active-link', 'underline'));
                        
                        // Add underline and active marker to this one
                        htmlLink.classList.add('active-link', 'underline');
                    }
                    // If it already has the class, the browser follows the href normally
                }
            });
        });

        // Optional: Reset links if the user clicks elsewhere on the screen
        document.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            if (!target.closest('.mobile-double-tap')) {
                links.forEach(l => l.classList.remove('active-link', 'underline'));
            }
        });
    });
</script>