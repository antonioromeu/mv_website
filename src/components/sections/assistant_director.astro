---
import { adContent } from '../../content/assistant_director';

interface Props {
    lang: 'en' | 'pt';
}

const { lang } = Astro.props;
const t = adContent[lang];

// Helper to chunk credits into pages of 4 for mobile
const perPage = 4;
const pages = Array.from({ length: Math.ceil(t.credits.length / perPage) }, (_, i) =>
    t.credits.slice(i * perPage, i * perPage + perPage)
);
const byLabel = lang === 'pt' ? 'de' : 'by';
---

<section 
    id="assistant-director" 
    data-color="var(--color-blue)" 
    class="snap-section shrink-0
           md:flex-row md:items-center"
    style={`padding-top: var(--nav-height);`}
>
    <!-- Mobile view -->
    <div class="flex flex-col w-full h-full overflow-hidden md:hidden">
        <!-- Header -->
        <div class="w-full px-[3.5vw] pt-[6vh] pb-[1vh]">
            <div class="border-b border-current pb-[1vh]">
                <span class="block text-xs font-bold">{t.title}</span>
            </div>
        </div>
        
        <!-- Scrollable pages container -->
        <div class="flex-1 overflow-x-auto snap-x snap-mandatory hide-scrollbar flex" id="assistant-scroll">
            {pages.map((page) => (
                <div class="w-full h-full snap-start flex px-[3.5vw] shrink-0">
                    <div class="text-[10px] leading-relaxed space-y-[1vh]">
                        {page.map(item => (
                            <div>
                                {item.link ? (
                                    <a href={item.link} target="_blank" class="mobile-double-tap no-underline font-bold">
                                        {item.title}
                                    </a>
                                ) : (
                                    <strong>{item.title} {item.status && <span>{item.status}</span>}</strong>
                                )}
                                <br />{byLabel} {item.director}
                                <br />{item.type}
                                <br />{item.production}
                                <br />{item.role}
                                <br />{item.date}
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>

        <!-- Page indicators -->
        <div class="flex justify-center gap-2 py-[2vh]">
            {pages.map((_, i) => (
                <div class={`page-indicator-ad w-1.5 h-1.5 rounded-full bg-current transition-opacity ${i === 0 ? 'opacity-100' : 'opacity-30'}`} data-page={i}></div>
            ))}
        </div>
    </div>

    <!-- Desktop view -->
    <div class="hidden flex-col w-full h-full pt-[3vh] px-[3.5vw] md:flex">
        <div class="w-full border-b border-current pb-2 mb-3">
            <div class="flex flex-col">
                <span class="block font-bold text-lg">{t.title}</span>
            </div>
        </div>
        <div class="columns-4 gap-8 text-[10px] leading-relaxed">
            {t.credits.map(item => (
                <div class="break-inside-avoid mb-3">
                    {item.link ? (
                        <a href={item.link} target="_blank" class="hover:underline font-bold">
                            {item.title}
                        </a>
                    ) : (
                        <strong>{item.title} {item.status && <span>{item.status}</span>}</strong>
                    )}
                    <br />{byLabel} {item.director}
                    <br />{item.type}
                    <br />{item.production}
                    <br />{item.role}
                    <br />{item.date}
                </div>
            ))}
        </div>
    </div>
</section>

<script>
    function initAD() {
        const scrollContainer = document.getElementById('assistant-scroll');
        const indicators = document.querySelectorAll('.page-indicator-ad');
        const doubleTapLinks = document.querySelectorAll('.mobile-double-tap');

        // 1. Scroll Indicator Logic
        if (scrollContainer && indicators.length > 0) {
            // Set initial state
            indicators[0].classList.replace('opacity-30', 'opacity-100');

            scrollContainer.addEventListener('scroll', () => {
                const currentPage = Math.round(scrollContainer.scrollLeft / scrollContainer.clientWidth);
                indicators.forEach((ind, i) => {
                    ind.classList.toggle('opacity-100', i === currentPage);
                    ind.classList.toggle('opacity-30', i !== currentPage);
                });
            }, { passive: true });
        }

        // 2. Mobile Double Tap Logic
        doubleTapLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (window.innerWidth < 768) {
                    const el = e.currentTarget as HTMLElement;
                    if (!el.classList.contains('active-link')) {
                        e.preventDefault();
                        doubleTapLinks.forEach(l => l.classList.remove('active-link', 'underline'));
                        el.classList.add('active-link', 'underline');
                    }
                }
            });
        });

        // Reset links when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!(e.target as HTMLElement).closest('.mobile-double-tap')) {
                doubleTapLinks.forEach(l => l.classList.remove('active-link', 'underline'));
            }
        });
    }

    // Initialize
    initAD();
    document.addEventListener('astro:page-load', initAD);
</script>